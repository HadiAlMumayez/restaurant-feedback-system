rules_version = '2';

/**
 * Firestore Security Rules for Restaurant Feedback System
 * 
 * DESIGN PRINCIPLES:
 * 1. Customer tablets can ONLY create reviews (no read/update/delete)
 * 2. Role-based access control (RBAC): owner, manager, viewer
 * 3. No one can delete data through client (use Firebase console for admin tasks)
 * 4. Validate data on write to prevent malicious input
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get admin document
    function getAdmin() {
      return get(/databases/$(database)/documents/admins/$(request.auth.uid)).data;
    }
    
    // Helper function to check if user is admin (has admin doc)
    function isAdmin() {
      return isAuthenticated() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Helper function to check if user is owner
    function isOwner() {
      return isAdmin() && getAdmin().role == 'owner';
    }
    
    // Helper function to check if user can access branch
    function canAccessBranch(branchId) {
      let admin = getAdmin();
      // Owners can access all branches, managers/viewers can only access allowed branches
      return admin.role == 'owner' || 
        (admin.branchIds != null && admin.branchIds is list && branchId in admin.branchIds);
    }
    
    // Helper function to validate rating value
    function isValidRating(rating) {
      return rating is int && rating >= 1 && rating <= 5;
    }
    
    // Helper function to validate string length
    function isValidString(value, maxLength) {
      return value == null || (value is string && value.size() <= maxLength);
    }
    
    // Helper function to check if branch exists and is active
    // Uses exists() for proper validation before accessing data
    function branchExistsAndActive(branchId) {
      return exists(/databases/$(database)/documents/branches/$(branchId))
        && get(/databases/$(database)/documents/branches/$(branchId)).data.isActive == true;
    }
    
    // Helper function to validate timestamp is near current time (prevents fake timestamps)
    // Allows timestamps within 10 minutes of request time (accounts for clock skew)
    // Note: Using duration.value() for time subtraction (Firestore rules v2)
    function isNearNow(ts) {
      return ts is timestamp
        && ts <= request.time
        && ts >= request.time - duration.value(10, 'm');
    }
    
    // Helper function to validate review data
    function isValidReview(data) {
      return data.keys().hasAll(['branchId', 'rating', 'createdAt'])
        && data.branchId is string
        && data.branchId.size() > 0
        && data.branchId.size() <= 50
        && isValidRating(data.rating)
        && isNearNow(data.createdAt)
        && isValidString(data.comment, 1000)
        && isValidString(data.customerName, 100)
        && isValidString(data.contact, 100)
        && isValidString(data.billId, 50);
    }
    
    /**
     * BRANCHES COLLECTION
     * - Read: Public can read only active branches; admins can read all
     * - Write: Only owners can create/update branches
     */
    match /branches/{branchId} {
      // Public can only get/list branches where isActive == true
      // Admins can get/list all branches
      allow get, list: if (resource.data.isActive == true) || isAdmin();
      
      // Only owners can create/update branches
      allow create: if isOwner()
        && request.resource.data.keys().hasAll(['name', 'location', 'isActive'])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 100
        && request.resource.data.location is string
        && request.resource.data.location.size() > 0
        && request.resource.data.location.size() <= 200
        && request.resource.data.isActive is bool
        && (request.resource.data.address == null || (request.resource.data.address is string && request.resource.data.address.size() <= 500));
      
      allow update: if isOwner();
      
      // No deletes from client
      allow delete: if false;
    }
    
    /**
     * REVIEWS COLLECTION
     * - Create: Anyone (customers on tablet) - with validation
     * - Read: Authenticated admins only (filtered by branchIds for managers/viewers)
     * - Update/Delete: None (immutable records)
     */
    match /reviews/{reviewId} {
      // Public create with strict validation and branch existence check
      allow create: if isValidReview(request.resource.data) 
        && branchExistsAndActive(request.resource.data.branchId);
      
      // Only admins can read reviews
      // Owners can read all reviews
      // Managers/viewers can only read reviews for their allowed branches
      allow read: if isAdmin() 
        && (isOwner() || canAccessBranch(resource.data.branchId));
      
      // No updates or deletes from client
      allow update, delete: if false;
    }
    
    /**
     * ADMINS COLLECTION (RBAC: role-based access control)
     * Document ID: Firebase Auth UID
     * Fields: role ('owner' | 'manager' | 'viewer'), branchIds (string[]), timestamps
     * - Read: Owners can read/list all; non-owners can only read their own
     * - Write: Only owners can create/update/delete admin records
     */
    match /admins/{adminId} {
      // Owners can get/list all admin docs
      // Non-owner admins can only get their own admin doc (not list everyone)
      allow get: if isOwner() || (isAdmin() && adminId == request.auth.uid);
      allow list: if isOwner();
      
      // Only owners can create/update admin records
      allow create: if isOwner()
        && request.resource.data.keys().hasAll(['role', 'createdAt', 'updatedAt'])
        && request.resource.data.role is string
        && request.resource.data.role in ['owner', 'manager', 'viewer']
        && (request.resource.data.branchIds == null || request.resource.data.branchIds is list);
      
      allow update: if isOwner()
        && request.resource.data.role is string
        && request.resource.data.role in ['owner', 'manager', 'viewer']
        && (request.resource.data.branchIds == null || request.resource.data.branchIds is list);
      
      // Only owners can delete admin records (except themselves)
      allow delete: if isOwner() && adminId != request.auth.uid;
    }
    
    /**
     * DEFAULT: Deny all other access
     */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}